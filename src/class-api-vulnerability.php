<?php
/**
 * Api_Vulnerability class.
 *
 * @package soter-core
 */

namespace Soter_Core;

use DateTime;

/**
 * Defines the API vulnerability class.
 */
class Api_Vulnerability {
	/**
	 * Cleaned up vulnerability array.
	 *
	 * @var  array
	 */
	protected $data = array();

	/**
	 * Raw vulnerability array provided by JSON decoding an API response.
	 *
	 * @var array
	 */
	protected $raw;

	/**
	 * Slug of the package that this vulnerability affects.
	 *
	 * @var string
	 */
	protected $slug;

	/**
	 * Class constructor.
	 *
	 * @param string $slug          Package slug affected by this vulnerability.
	 * @param array  $vulnerability JSON decoded vulnerability array.
	 */
	public function __construct( $slug, array $vulnerability ) {
		$timestamps = array( 'created_at', 'published_date', 'updated_at' );

		$this->slug = (string) $slug;
		$this->raw = $vulnerability;

		foreach ( $vulnerability as $key => $value ) {
			// @todo Better to just leave as received from API?
			if ( is_string( $value ) ) {
				$value = trim( $value );
			}

			// It looks like published_date is often null.
			if ( $value && in_array( $key, $timestamps, true ) ) {
				$value = new DateTime( $value );
			}

			$this->data[ $key ] = $value;
		}
	}

	/**
	 * Magic getter - proxies all property requests to timestamps or data arrays.
	 *
	 * @param  string $key Property name.
	 *
	 * @return mixed
	 */
	public function __get( $key ) {
		if ( array_key_exists( $key, $this->data ) ) {
			return $this->data[ $key ];
		}

		return null;
	}

	/**
	 * Returns the vulnerability ID when object is requested as a string. This is
	 * intended solely for use by array_unique.
	 *
	 * @return string
	 */
	public function __toString() {
		return (string) $this->id;
	}

	/**
	 * Check whether this vulnerabilty affects a given package version.
	 *
	 * @param  string $version Package version.
	 *
	 * @return boolean
	 */
	public function affects_version( $version ) {
		return is_null( $this->data['fixed_in'] )
			|| version_compare( (string) $version, $this->data['fixed_in'], '<' );
	}

	/**
	 * Data getter.
	 *
	 * @return array
	 */
	public function get_data() {
		return $this->data;
	}

	/**
	 * Raw data getter.
	 *
	 * @return array
	 */
	public function get_raw() {
		return $this->raw;
	}

	/**
	 * Slug getter.
	 *
	 * @return string
	 */
	public function get_slug() {
		return $this->slug;
	}
}
