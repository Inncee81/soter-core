<?php

use Soter_Core\Api_Vulnerability;

class Api_Vulnerability_Test extends WP_UnitTestCase {
	use Gets_Http_Fixtures_Trait;

	/** @test */
	function it_trims_individual_data_points() {
		$vuln = new Api_Vulnerability(
			'contact-form-7',
			$this->get_first_vulnerability( '/api/v2/plugins/contact-form-7' )
		);

		// Actual response includes a trailing space.
		$this->assertEquals(
			'Contact Form 7 <= 3.7.1 - Security Bypass',
			$vuln->title
		);
	}

	/** @test */
	function it_converts_timestamps_to_datetime_objects() {
		$vuln = new Api_Vulnerability(
			'contact-form-7',
			$this->get_first_vulnerability( '/api/v2/plugins/contact-form-7' )
		);

		$this->assertEquals( new DateTime( '2014-08-01T10:59:06.000Z' ), $vuln->created_at );
		$this->assertEquals( new DateTime( '2015-05-15T13:48:25.000Z' ), $vuln->updated_at );
		$this->assertNull( $vuln->published_date );
	}

	/** @test */
	function it_can_be_cast_to_string() {
		$vuln = new Api_Vulnerability(
			'contact-form-7',
			$this->get_first_vulnerability( '/api/v2/plugins/contact-form-7' )
		);

		$this->assertEquals( '7020', (string) $vuln );
	}

	/** @test */
	function it_provides_access_to_all_props_included_in_api_response() {
		$vuln = new Api_Vulnerability(
			'contact-form-7',
			$this->get_first_vulnerability( '/api/v2/plugins/contact-form-7' )
		);

		$this->assertEquals( 'integer', gettype( $vuln->id ) );

		foreach ( [ 'title', 'vuln_type', 'fixed_in' ] as $key ) {
			$this->assertEquals( 'string', gettype( $vuln->{$key} ) );
		}

		foreach ( [ 'created_at', 'updated_at' ] as $key ) {
			$this->assertEquals( 'object', gettype( $vuln->{$key} ) );
		}

		// A bit odd - would be null if not set. Need to find a response where this
		// is actually set and swap it out for this test.
		$this->assertNull( $vuln->published_date );

		$this->assertEquals( 'array', gettype( $vuln->references ) );
	}

	/** @test */
	function it_provides_access_to_full_data_array() {
		$vuln = new Api_Vulnerability(
			'contact-form-7',
			$this->get_first_vulnerability( '/api/v2/plugins/contact-form-7' )
		);

		$this->assertEquals(
			// Testing for lack of trailing space.
			'Contact Form 7 <= 3.7.1 - Security Bypass',
			$vuln->get_data()['title']
		);
	}

	/** @test */
	function it_provides_access_to_raw_data_array() {
		$vuln = new Api_Vulnerability(
			'contact-form-7',
			$this->get_first_vulnerability( '/api/v2/plugins/contact-form-7' )
		);

		$this->assertEquals(
			// Testing for trailing space.
			'Contact Form 7 <= 3.7.1 - Security Bypass ',
			$vuln->get_raw()['title']
		);
	}

	/** @test */
	function it_provides_access_to_package_slug() {
		$vuln = new Api_Vulnerability(
			'contact-form-7',
			$this->get_first_vulnerability( '/api/v2/plugins/contact-form-7' )
		);

		$this->assertEquals( 'contact-form-7', $vuln->get_slug() );
	}

	protected function get_first_vulnerability( $path ) {
		$response = static::get_http_fixture_array( $path );

		$decoded = json_decode( $response[2], true );
		$body = array_shift( $decoded );

		$vulns = isset( $body['vulnerabilities'] ) ? $body['vulnerabilities'] : [];

		return array_shift( $vulns );
	}
}
